---
# yaml-language-server: $schema=https://creativeprojects.github.io/resticprofile/jsonschema/config-1.json
version: "1"

global:
  scheduler: crond
  default-command: snapshots
  restic-lock-retry-after: 5m
  restic-stale-lock-age: 24h

default:
  lock: "/tmp/resticprofile-profile-default.lock"
  force-inactive-lock: true
  compression: max
  initialize: true
  verbose: true
  priority: low
  min-memory: 100

  env:
    RESTIC_CACHE_DIR: "/mnt/nfs-tmp/resticprofile-cache"

  backup:
    schedule: daily
    schedule-log: /logs/resticprofile.log
    schedule-permission: user
    schedule-lock-wait: 2h
    source:
      - /backups/pgbackups
    exclude: []
    no-error-on-warning: true
    # run-before: |
    #   wget "https://hc-ping.com/FW89_Ui4S7Xe4QLa96f98A/kube-restic-${PROFILE_NAME}-${PROFILE_COMMAND}/start?rid=$(cat /tmp/uuid)" -O - -S --post-data "Profile: $PROFILE_NAME
    #   Command: $PROFILE_COMMAND
    #   "
    # run-finally: |
    #   # Extract lines that don't start with "unchanged " from the log and write them to "backup.log" in the current directory
    #   grep --invert-match -E "^unchanged\\s" {{ tempFile "backup.log" }} > backup.log
    #   rc="${ERROR_EXIT_CODE:-0}";
    #   wget "https://hc-ping.com/FW89_Ui4S7Xe4QLa96f98A/kube-restic-${PROFILE_NAME}-${PROFILE_COMMAND}/${rc}?rid=$(cat /tmp/uuid)" -O - -S --post-data "Profile: $PROFILE_NAME
    #   Command: $PROFILE_COMMAND
    #   Message: $ERROR_MESSAGE
    #   Command-line: $ERROR_COMANDLINE
    #   Stderr: $ERROR_STDERR
    #   "

  forget:
    # check the repository the first day of each month at 3am
    schedule: "*-*-01 03:00"
    schedule-permission: user
    schedule-log: /logs/resticprofile.log
    keep-hourly: 24
    keep-daily: 14
    keep-monthly: 24
    keep-weekly: 12
    prune: true

  check:
    schedule-permission: user
    schedule-log: /logs/resticprofile.log
    read-data-subset: "100M"

  restore:
    target: "/mnt/nfs-tmp/resticprofile-restore"
