state_dir /cache/state
runtime_dir /cache/run

openmetrics tcp://0.0.0.0:{env:SMTP_RELAY_METRICS_PORT} { }

tls off
hostname {env:SMTP_RELAY_HOSTNAME}

# Submission endpoint - automatically requires authentication
submission tcp://0.0.0.0:{env:SMTP_RELAY_SMTP_PORT} {
    auth pass_table file /auth/smtp_passwd
    
    # Only allow relay for authenticated users
    # Using wildcard source to accept any authenticated connection
    source * {
        default_destination {
            deliver_to &remote_queue
        }
    }
    
    # This block handles unauthenticated connections
    # Since submission requires auth by default, this shouldn't be reached
    default_source {
        reject 530 5.7.0 "Authentication required"
    }
}

target.queue remote_queue {
    target &remote_smtp
}

target.smtp remote_smtp {
    starttls yes
    auth plain {env:SMTP_RELAY_UPSTREAM_USERNAME} {env:SMTP_RELAY_UPSTREAM_PASSWORD}
    targets tcp://{env:SMTP_RELAY_UPSTREAM_SERVER}:{env:SMTP_RELAY_UPSTREAM_SERVER_PORT}
}
