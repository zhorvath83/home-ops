# Maddy Mail Server - basic configuration for local email delivery
# Documentation: https://maddy.email/docs/

state_dir /cache/state
runtime_dir /cache/run

openmetrics tcp://0.0.0.0:{env:SMTP_RELAY_METRICS_PORT} { }

# TLS configuration - using cert-manager certificate
tls file /etc/maddy/tls/tls.crt /etc/maddy/tls/tls.key {
    # Modern cipher suites for ECDSA certificates
    protocols tls1.3
    
    # Cipher suites optimized for ECDSA P-256
    ciphers ECDHE-ECDSA-WITH-AES256-GCM-SHA384 ECDHE-ECDSA-WITH-AES128-GCM-SHA256 ECDHE-ECDSA-WITH-CHACHA20-POLY1305
    
    # Elliptic curves - P-256 is our primary
    curves p256 p384 p521
}

# Authentication
auth.pass_table local_authdb {
    table sql_table {
        driver sqlite3
        dsn credentials.db
        table_name passwords
    }
}

hostname {env:SMTP_RELAY_HOSTNAME}

smtp tcp://0.0.0.0:{env:SMTP_RELAY_SMTP_PORT} {
    auth &local_authdb
    tls required
    max_message_size 30MiB

    default_source {
        deliver_to &remote_queue
    }
}

target.queue remote_queue {
    target &remote_smtp
}

target.smtp remote_smtp {
    starttls yes
    auth plain {env:SMTP_RELAY_UPSTREAM_USERNAME} {env:SMTP_RELAY_UPSTREAM_PASSWORD}
    targets tcp://{env:SMTP_RELAY_UPSTREAM_SERVER}:{env:SMTP_RELAY_UPSTREAM_SERVER_PORT}
}
