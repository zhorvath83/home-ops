---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: crowdsec-bouncer
  namespace: networking
spec:
  interval: 15m
  chart:
    spec:
      chart: envoy-proxy-bouncer
      version: 0.4.2
      sourceRef:
        kind: HelmRepository
        name: envoy-proxy-bouncer
        namespace: flux-system

  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  uninstall:
    keepHistory: false

  values:
    replicaCount: 1

    config:
      server:
        grpcPort: 8080
        httpPort: 8081
        logLevel: info

      # Cloudflare Tunnel IPs - traffic comes from cluster internal
      trustedProxies:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16

      bouncer:
        enabled: true
        metrics: true
        tickerInterval: "10s"
        metricsInterval: "10m"
        banStatusCode: 403
        lapiURL: "http://crowdsec-service.security.svc.cluster.local:8080"
        apiKeySecretRef:
          name: crowdsec-bouncer-secret
          key: api-key

      # WAF disabled initially - enable after basic bouncer works
      waf:
        enabled: false

      # CAPTCHA disabled initially
      captcha:
        enabled: false

    resources:
      requests:
        cpu: 10m
        memory: 64Mi
      limits:
        memory: 128Mi

    # ReferenceGrant created separately for namespace access
    referenceGrant:
      create: false
