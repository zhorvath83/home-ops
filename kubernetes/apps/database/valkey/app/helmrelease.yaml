---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: valkey
  namespace: database
spec:
  interval: 15m
  chart:
    spec:
      chart: valkey
      version: 3.0.30
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system

  install:
    createNamespace: true
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  uninstall:
    keepHistory: false

  values:
    # Use specified valkey image
    image:
      registry: ghcr.io
      repository: valkey-io/valkey
      tag: "8.1.3"

    # Architecture - single primary for resource efficiency
    architecture: standalone

    auth:
      enabled: true
      # Use external secrets for password management
      existingSecret: "valkey-secret"
      existingSecretPasswordKey: "password"

    # Resource configuration following project guidelines
    primary:
      configuration: |-
        # Custom valkey configuration for single-node deployment
        # Optimize for resource efficiency
        maxmemory 256mb
        maxmemory-policy allkeys-lru
        save 900 1
        save 300 10
        save 60 10000

      resources:
        requests:
          cpu: 10m
          memory: 128Mi
        limits:
          memory: 512Mi

      # Persistence configuration
      persistence:
        enabled: true
        storageClass: ""  # Use default democratic-csi
        accessModes:
          - ReadWriteOnce
        size: 2Gi
        path: "/data"

      # Security context - rootless following project standards
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 10001
        runAsGroup: 10001
        fsGroup: 10001
        fsGroupChangePolicy: OnRootMismatch

      containerSecurityContext:
        privileged: false
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: false  # Valkey needs to write config files
        capabilities:
          drop:
            - ALL

      # Service configuration
      service:
        type: ClusterIP
        ports:
          valkey: 6379

    # Disable replicas for single-node deployment
    replica:
      replicaCount: 0

    # Disable sentinel for standalone mode  
    sentinel:
      enabled: false

    # Enable metrics for potential future monitoring
    metrics:
      enabled: false  # Start disabled, can be enabled later
      serviceMonitor:
        enabled: false

    # Network policies - none needed for internal use
    networkPolicy:
      enabled: false
