---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: traefik
  namespace: traefik
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://helm.traefik.io/traefik
      chart: traefik
      version: 10.1.1
      sourceRef:
        kind: HelmRepository
        name: traefik-charts
        namespace: flux-system
      interval: 5m
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
  rollback:
    timeout: 10m
    recreate: true

  values:
    deployment:
      kind: Deployment
      replicas: 3

    env:
    - name: TZ
      value: ${CLUSTER_TIMEZONE}

    ingressClass:
      enabled: true
      isDefaultClass: true
      fallbackApiVersion: v1
    ingressRoute:
      dashboard:
        enabled: false

    globalArguments:
    - "--global.checknewversion=false"
    - "--global.sendanonymoususage=true"
    additionalArguments:
    - "--metrics.prometheus=true"
    - "--metrics.prometheus.entryPoint=metrics"
    # Load dynamic configuration from one or more .yaml files.
    - "--providers.file.directory=/config"
    - "--providers.file.watch=true"
    # Allow these IPs to set the X-Forwarded-* headers.
    - "--entrypoints.websecure.forwardedHeaders.trustedIPs=${CLUSTER_CF_IPV4_IPS}"
    # Disable SSL verification on backend
    - "--serverstransport.insecureskipverify=true"
    - "--providers.kubernetesingress.ingressclass=traefik"
    # providers.kubernetesingress.ingressendpoint.hostname is set for external-dns support
    - "--providers.kubernetesingress.ingressendpoint.hostname=${SECRET_CLUSTER_DOMAIN}"

    ports:
      traefik:
        expose: false
        port: 9000
        protocol: TCP
      web:
        # expose: false
        # exposedPort: 80
        # port: 8000
        # protocol: TCP
        redirectTo: websecure
      websecure:
        expose: true
        exposedPort: 443
        port: 8443
        protocol: TCP
        tls:
          enabled: true
          options: "default"
      metrics:
        port: 8082
        expose: true
        exposedPort: 8082

    service:
      enabled: true
      type: LoadBalancer
      spec:
        loadBalancerIP: ${CLUSTER_SVC_TRAEFIK_IP}
        externalTrafficPolicy: Local

    dnsPolicy: ClusterFirst

    logs:
      general:
        # (Default: ERROR) DEBUG, INFO, WARN, ERROR, FATAL, PANIC
        level: WARN
      access:
        enabled: true
        bufferingSize: 100
        filters:
          statuscodes: "400-599"
        fields:
          general:
            defaultmode: keep
            names:
              StartUTC: drop
          headers:
            defaultmode: drop
            names: {}

    pilot:
      enabled: true
      token: "${SECRET_TRAEFIK_PILOT_TOKEN}"

    experimental:
      plugins:
        enabled: false

    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - traefik
            topologyKey: "kubernetes.io/hostname"

    resources:
      requests:
        cpu: 50m
        memory: 80Mi
      limits:
        cpu: 500m
        memory: 500Mi
