---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: wikijs
  namespace: default
  labels:
    app.kubernetes.io/name: wikijs
spec:
  replicas: 1
  strategy:
    # All existing Pods are killed before new ones are created
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: wikijs
  template:
    metadata:
      labels:
        app.kubernetes.io/name: wikijs
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
      volumes:
        - name: wikijs-data
          persistentVolumeClaim:
            claimName: wikijs-data
        - name: wikijs-config
          configMap:
            name: wikijs-config
            items:
              - key: config.yaml
                path: config.yml

      containers:
        - name: wikijs
          image: ghcr.io/requarks/wiki:2.5.287
          imagePullPolicy: IfNotPresent
          env: []
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
          startupProbe:
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 60
            httpGet:
              path: /healthz
              port: http
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP

          volumeMounts:
            - name: wikijs-data
              mountPath: /usr/wikijs/assets
            - name: wikijs-config
              mountPath: /wiki/config.yml
              subPath: config.yml
          resources:
            requests:
              memory: 50Mi
              cpu: 50m
            limits:
              memory: 1024Mi
              cpu: 3500m

      initContainers:
        - name: database-bootstrap
          image: bitnami/postgresql:14.2.0-debian-10-r88
          imagePullPolicy: IfNotPresent
          env:
            - name: POSTGRES_PASSWORD
              value: ${SECRET_PSQL_POSTGRES_PWD}
            - name: POSTGRES_USER
              value: postgres
            - name: POSTGRES_DB_PASSWORD
              value: ${SECRET_PSQL_WIKIJS_PWD}
            - name: POSTGRES_DB_USER
              value: WIKIJS
            - name: POSTGRES_HOST
              value: postgresql.selfhosted.svc.cluster.local
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_DB_NAME
              value: WIKIJS
          command:
            - sh
            - "-c"
            - |
              until pg_isready -h $POSTGRES_HOST -p 5432 -U postgres
              do
                echo "Waiting for PostgreSQL... "
                sleep 5;
              done
              if PGPASSWORD=$POSTGRES_PASSWORD psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -lqt | cut -d \| -f 1 | grep -qw $POSTGRES_DB_NAME; then
                PGPASSWORD=$POSTGRES_PASSWORD psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER <<-EOSQL
                ALTER USER $POSTGRES_DB_USER WITH NOSUPERUSER;
              EOSQL
                echo "database already exist, exiting initContainer"
                exit 0
              else
                echo "Database does not exist. creating...."
                PGPASSWORD=$POSTGRES_PASSWORD psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER <<-EOSQL
                CREATE DATABASE $POSTGRES_DB_NAME;
                CREATE USER $POSTGRES_DB_USER WITH ENCRYPTED PASSWORD '$POSTGRES_DB_PASSWORD';
                GRANT all privileges ON database $POSTGRES_DB_NAME TO $POSTGRES_DB_USER;
                CREATE EXTENSION pg_trgm;
              EOSQL
              echo "Done"
              fi
