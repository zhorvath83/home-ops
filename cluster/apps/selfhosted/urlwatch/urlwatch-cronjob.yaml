---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: urlwatch
  namespace: selfhosted
  labels:
    app.kubernetes.io/name: urlwatch
spec:
  schedule: "0 0 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          automountServiceAccountToken: false
          containers:
          - name: urlwatch
            # Pinned version because of non working release
            image: vimagick/urlwatch@sha256:edf9d7e539c1d5cd50d8cc06ab07f0a6fa2bd7b304c35cabd7780c840b2bb7de
            imagePullPolicy: IfNotPresent
            command:
            - sh
            - -exec
            - |
              cd /root/.urlwatch
              urlwatch --urls urls.yaml --config urlwatch.yaml --hooks hooks.py --cache cache.db
            securityContext:
              readOnlyRootFilesystem: true
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                - all
            resources:
              requests:
                cpu: 50m
                memory: 96Mi
              limits:
                memory: 384Mi
            volumeMounts:
            - name: urlwatch-data
              mountPath: /root/.urlwatch
            - name: urlwatch-config
              mountPath: /root/.urlwatch/urlwatch.yaml
              subPath: urlwatch.yaml
              readOnly: true
            - name: urlwatch-config
              mountPath: /root/.urlwatch/urls.yaml
              subPath: urls.yaml
              readOnly: true
            - name: urlwatch-config
              mountPath: /root/.urlwatch/hooks.py
              subPath: hooks.py
              readOnly: true
          volumes:
          - name: urlwatch-config
            configMap:
              name: urlwatch-config
          - name: urlwatch-data
            persistentVolumeClaim:
              claimName: urlwatch-data
