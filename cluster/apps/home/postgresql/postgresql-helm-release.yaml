---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: postgresql
  namespace: home
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://k8s-at-home.com/charts/
      chart: zalando-postgres-cluster
      version: 2.3.0
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home-charts
        namespace: flux-system
      interval: 5m
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
  rollback:
    timeout: 10m
    recreate: true

  values:
    postgresql:
      users:
        postgres:
        - superuser
        - createdb
      databases:
        postgres: postgres
      postgresql:
        version: "13"

    superuser:
      secret: postgres.postgres.credentials.postgresql.acid.zalan.do

    persistentVolumes:
      existingClaim: postgresql-data
      replicaNodes:
      - ${CLUSTER_K8S_NODE_1}
      - ${CLUSTER_K8S_NODE_2}
      - ${CLUSTER_K8S_NODE_3}
    
    dumpBackup:
      enabled: true
      type: custom
      hostPath:
        path: /mnt/backup
      schedule: "@daily"
