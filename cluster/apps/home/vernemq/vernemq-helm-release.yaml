---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vernemq
  namespace: home
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://vernemq.github.io/docker-vernemq
      chart: vernemq
      version: 1.6.12
      sourceRef:
        kind: HelmRepository
        name: vernemq-charts
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
  rollback:
    timeout: 10m
    recreate: true

  values:
    image:
      repository: vernemq/vernemq
      tag: 1.12.3-alpine
      pullPolicy: IfNotPresent

    replicaCount: 1

    service:
      type: LoadBalancer
      loadBalancerIP: ${CLUSTER_SVC_MQTT_IP}
      mqtt:
        enabled: true
        port: 1883

    persistentVolume:
      enabled: true
      size: 1Gi
      storageClass: rook-ceph-block

    additionalEnv:
    - name: DOCKER_VERNEMQ_ACCEPT_EULA
      value: "yes"
    - name: DOCKER_VERNEMQ_USER_${SECRET_CLUSTER_OWNER_USERNAME}
      value: "${SECRET_MQTT_PASSWORD}"
    # PodAntiAffinity configured to ensure the scheduler does not co-locate replicas on a single node.
    podAntiAffinity: hard

    envFrom: []

    affinity:
      podAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - home-assistant
            topologyKey: "kubernetes.io/hostname"
