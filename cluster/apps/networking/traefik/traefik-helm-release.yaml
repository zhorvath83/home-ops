---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: traefik
  namespace: networking
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://helm.traefik.io/traefik
      chart: traefik
      version: 10.6.0
      sourceRef:
        kind: HelmRepository
        name: traefik-charts
        namespace: flux-system
      interval: 5m
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
  rollback:
    timeout: 10m
    recreate: true

  dependsOn:
    - name: cert-manager
      namespace: cert-manager

  values:

    image:
      name: ghcr.io/k8s-at-home/traefik
      pullPolicy: IfNotPresent

    deployment:
      kind: Deployment
      replicas: 2

    env:
    - name: TZ
      value: ${CLUSTER_TIMEZONE}

    logs:
      general:
        format: json
        level: DEBUG
      access:
        enabled: true
        format: json

    ingressClass:
      enabled: true
      isDefaultClass: true
      fallbackApiVersion: v1
    ingressRoute:
      dashboard:
        enabled: false

    globalArguments:
    - "--global.checknewversion=false"
    - "--global.sendanonymoususage=true"
    additionalArguments:
    - "--metrics.prometheus=false"
    - "--metrics.prometheus.entryPoint=metrics"
    # Allow these IPs to set the X-Forwarded-* headers.
    - "--entryPoints.websecure.forwardedHeaders.trustedIPs=${CLUSTER_CF_IPV4_IPS}"
    # Disable SSL verification on backend
    - "--serverstransport.insecureskipverify=true"
    - "--providers.kubernetesingress.ingressclass=traefik"
    # providers.kubernetesingress.ingressendpoint.hostname is set for external-dns support
    - "--providers.kubernetesingress.ingressendpoint.hostname=${SECRET_DOMAIN}"

    ports:
      traefik:
        expose: false
        port: 9000
        protocol: TCP
      web:
        # expose: false
        # exposedPort: 80
        # port: 8000
        # protocol: TCP
        redirectTo: websecure
      websecure:
        expose: true
        exposedPort: 443
        port: 8443
        protocol: TCP
        tls:
          enabled: true
          options: "default"
      metrics:
        port: 8082
        expose: true
        exposedPort: 8082

    service:
      enabled: true
      type: LoadBalancer
      spec:
        loadBalancerIP: ${CLUSTER_SVC_TRAEFIK_IP}
        externalTrafficPolicy: Local

    dnsPolicy: ClusterFirst

    pilot:
      enabled: false
    experimental:
      plugins:
        enabled: false

    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - traefik
          topologyKey: kubernetes.io/hostname

    resources:
      requests:
        cpu: 50m
        memory: 80Mi
      limits:
        cpu: 500m
        memory: 500Mi
