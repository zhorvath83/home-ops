---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: home-assistant
  namespace: default
  labels:
    app.kubernetes.io/name: home-assistant
spec:
  replicas: 1
  strategy:
    # All existing Pods are killed before new ones are created
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: home-assistant
  template:
    metadata:
      labels:
        app.kubernetes.io/name: home-assistant
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
      hostNetwork: true
      volumes:
        - name: home-assistant-data
          persistentVolumeClaim:
            claimName: home-assistant-data
        - name: home-assistant-customcomponents
          emptyDir: {}
        # - name: home-assistant-binarysensors
        #   configMap:
        #     name: home-assistant-binarysensors
        # - name: home-assistant-templates
        #   configMap:
        #     name: home-assistant-templates
        - name: home-assistant-config
          configMap:
            name: home-assistant-config
      initContainers:
        - name: cc-dwains-dashboard
          image: alpine/git
          command: ["/bin/sh"]
          args:
            - -c
            - |
              git clone --branch 3.0 https://github.com/dwainscheeren/dwains-lovelace-dashboard.git /config/custom_components/dwains_dashboard_repo 
              mv /config/custom_components/dwains_dashboard_repo/custom_components/dwains_dashboard/ /config/custom_components/dwains_dashboard 
              rm -rf /config/custom_components/dwains_dashboard_repo
          volumeMounts:
            - mountPath: /config/custom_components
              name: home-assistant-customcomponents
        # - name: cc-alarmo
        #   image: alpine/git
        #   command: ["/bin/sh"]
        #   args:
        #     - -c
        #     - |
        #       git clone --branch v1.9.6 https://github.com/nielsfaber/alarmo.git /config/custom_components/alarmo_repo 
        #       mv /config/custom_components/alarmo_repo/custom_components/alarmo/ /config/custom_components/alarmo 
        #       rm -rf /config/custom_components/alarmo_repo
        #   volumeMounts:
        #     - mountPath: /config/custom_components
        #       name: home-assistant-customcomponents
      containers:
        - name: home-assistant
          image: homeassistant/home-assistant:2022.11.5
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 3000m
              memory: 1024Mi
          envFrom:
            - configMapRef:
                name: home-assistant-env-vars
          # securityContext:
          #   privileged: true
          ports:
            - containerPort: 8123
              name: http
              protocol: TCP
          volumeMounts:
            - mountPath: /config/custom_components
              name: home-assistant-customcomponents
            - mountPath: /config
              name: home-assistant-data
              subPath: config
            # - mountPath: /config/binarysensors
            #   name: home-assistant-binarysensors
            # - mountPath: /config/templates
            #   name: home-assistant-templates
            - mountPath: /config/configuration.yaml
              name: home-assistant-config
              subPath: configuration.yaml
